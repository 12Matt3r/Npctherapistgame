<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPC Therapy - Ultimate AI Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            text-align: center;
            image-rendering: pixelated;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        /* CRT Filter Overlay */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 0, 0.1) 2px,
                rgba(0, 255, 0, 0.1) 4px
            );
            z-index: 9999;
            opacity: 0.3;
            animation: scanlines 0.1s linear infinite;
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        #gameContainer {
            max-width: 900px;
            margin: 0 auto;
            background: #000;
            border: 4px solid #6ff;
            box-shadow: 0 0 30px rgba(102, 255, 255, 0.5);
            position: relative;
            min-height: 650px;
            transition: background 0.5s ease;
            overflow: hidden;
        }

        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #101820 0%, #1a1a2e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
        }

        #npcCreation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1001;
            overflow-y: auto;
        }

        #glitchScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            z-index: 1002;
            animation: glitch 2s ease-in-out;
        }

        @keyframes glitch {
            0% { filter: none; }
            25% { filter: hue-rotate(90deg) contrast(200%); }
            50% { filter: hue-rotate(180deg) invert(100%); }
            75% { filter: hue-rotate(270deg) contrast(200%); }
            100% { filter: none; }
        }

        .form-group {
            margin: 15px 0;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: #6ff;
            font-size: 10px;
            margin-bottom: 5px;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            background: #222;
            border: 1px solid #6ff;
            color: #fff;
            font-family: inherit;
            font-size: 10px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .start-btn, .save-btn, .create-btn {
            background: #6ff;
            border: none;
            padding: 12px 24px;
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            color: #000;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .start-btn:hover, .save-btn:hover, .create-btn:hover {
            background: #8ff;
            transform: translateY(-2px);
        }

        #game {
            width: 100%;
            height: 650px;
            display: none;
            position: relative;
        }

        #mainGameArea {
            display: flex;
            height: 100%;
        }

        #leftPanel {
            width: 65%;
            position: relative;
        }

        #rightPanel {
            width: 35%;
            background: rgba(0, 0, 0, 0.8);
            border-left: 2px solid #6ff;
            display: flex;
            flex-direction: column;
        }

        #npcSprite {
            width: 100%;
            height: 380px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            transition: all 0.5s ease-in-out;
        }

        /* NPC State Animations */
        .npc-anxious {
            animation: anxious-shake 2s infinite;
        }

        .npc-crying {
            animation: crying-pulse 1.5s infinite;
        }

        .npc-glitched {
            animation: glitch-shake 0.3s infinite;
        }

        .npc-calm {
            animation: gentle-breathe 3s infinite;
        }

        @keyframes anxious-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        @keyframes crying-pulse {
            0%, 100% { opacity: 1; filter: brightness(1); }
            50% { opacity: 0.7; filter: brightness(0.8) drop-shadow(0 0 10px #6ff); }
        }

        @keyframes glitch-shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            20% { transform: translate(-2px, 2px) rotate(-1deg); }
            40% { transform: translate(-2px, -2px) rotate(1deg); }
            60% { transform: translate(2px, 2px) rotate(0deg); }
            80% { transform: translate(2px, -2px) rotate(-1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        @keyframes gentle-breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Particle Effects */
        #particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #6ff;
            animation: float 4s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        /* Couch Area */
        #couchArea {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 270px;
            background: linear-gradient(to bottom, transparent, #2a1810 50%, #1a0e08);
            transition: filter 0.5s ease;
        }

        #couch {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 70px;
            background: linear-gradient(135deg, #4a2a1a, #6a3a2a);
            border: 3px solid #8a4a3a;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        #couch.stressed {
            background: linear-gradient(135deg, #5a1a1a, #7a2a2a);
            border-color: #9a3a3a;
        }

        #couch.calm {
            background: linear-gradient(135deg, #1a3a3a, #2a5a5a);
            border-color: #3a6a6a;
        }

        #couch::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            height: 30px;
            background: linear-gradient(135deg, #5a3a2a, #7a4a3a);
            border: 3px solid #9a5a4a;
            border-radius: 10px;
        }

        /* Window View */
        #windowView {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 100px;
            height: 60px;
            background: linear-gradient(to bottom, #2a4a6a, #4a6a8a);
            border: 2px solid #6a8a;
            border-radius: 3px;
            opacity: 0.8;
        }

        /* Dialogue and UI */
        #dialogue {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            font-size: 9px;
            line-height: 1.6;
            color: #fff;
            border-top: 2px solid #6ff;
            max-height: 220px;
            overflow-y: auto;
        }

        #controls {
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 8px;
        }

        .control-btn {
            background: #444;
            border: 1px solid #6ff;
            color: #6ff;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 8px;
            transition: all 0.3s ease;
        }

        .control-btn:hover, .control-btn.active {
            background: #6ff;
            color: #000;
        }

        #therapyTools {
            display: none;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
        }

        #freeInputMode {
            display: none;
            padding: 15px;
        }

        #patientLogs {
            display: none;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
        }

        .emotionMeter {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #6ff;
            height: 20px;
            margin: 5px 0;
            position: relative;
        }

        .emotionBar {
            height: 100%;
            transition: width 0.5s ease;
            position: relative;
        }

        .hope-bar { background: linear-gradient(90deg, #444, #6ff); }
        .rage-bar { background: linear-gradient(90deg, #444, #f66); }
        .acceptance-bar { background: linear-gradient(90deg, #444, #6f6); }

        .emotionLabel {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 8px;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        .emotionValue {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 8px;
            color: white;
        }

        .tool-item {
            background: rgba(102, 255, 255, 0.1);
            border: 1px solid #6ff;
            padding: 8px;
            margin: 5px 0;
            cursor: pointer;
            font-size: 8px;
            transition: all 0.3s ease;
        }

        .tool-item:hover {
            background: rgba(102, 255, 255, 0.3);
            transform: translateX(5px);
        }

        .tool-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .npc-name {
            color: #6ff;
            font-size: 11px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #6ff;
        }

        .monologue {
            margin-bottom: 15px;
            color: #ccc;
            animation: typewriter 3s steps(40, end);
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid #6ff;
        }

        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .choice {
            display: block;
            padding: 8px 12px;
            border: 1px solid #6ff;
            background: rgba(0, 0, 0, 0.7);
            color: #6ff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 8px;
        }

        .choice:hover {
            background: #6ff;
            color: #000;
            transform: translateX(5px);
        }

        .typing-indicator {
            color: #6ff;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .freeInput {
            width: 100%;
            padding: 8px;
            background: #222;
            border: 1px solid #6ff;
            color: #fff;
            font-family: inherit;
            font-size: 10px;
            margin: 5px 0;
        }

        .breakthrough-log {
            background: rgba(102, 255, 255, 0.1);
            border: 1px solid #6ff;
            padding: 8px;
            margin: 5px 0;
            font-size: 8px;
        }

        .connected-stories {
            color: #ff6;
            font-size: 7px;
            font-style: italic;
            margin: 5px 0;
        }

        .transference-text {
            color: #f6f;
            font-size: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .fourth-wall-break {
            background: linear-gradient(45deg, #000, #333);
            border: 2px solid #f66;
            animation: glitch 0.5s infinite;
            padding: 10px;
            margin: 10px 0;
            font-size: 8px;
        }

        .meta-npc-warning {
            color: #f66;
            font-size: 6px;
            animation: flicker 1s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Hidden features */
        .secret-patient {
            display: none;
            animation: appear 3s ease-in-out;
        }

        @keyframes appear {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 1000px) {
            #mainGameArea { flex-direction: column; }
            #leftPanel, #rightPanel { width: 100%; }
            #rightPanel { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>
    
    <div id="gameContainer">
        <div id="startScreen">
            <h1>NPC Therapy</h1>
            <h2 style="color: #6ff; font-size: 12px;">ULTIMATE AI EDITION</h2>
            <p style="font-size: 9px; max-width: 600px; line-height: 1.6; margin: 20px;">
                Enhanced with emotional states, procedural dialogue, interconnected stories, and avant-garde meta-narratives.
                NPCs will now form relationships, break the fourth wall, and challenge your very role as therapist.
            </p>
            <button class="start-btn" onclick="startGame()">Begin Therapy Session</button>
            <button class="create-btn" onclick="showNPCCreation()">Create New NPC</button>
            <div id="hiddenLobby" style="margin-top: 20px; font-size: 8px; color: #666;">
                <div class="meta-npc-warning">WARNING: This therapy practice has encountered deleted save files</div>
            </div>
            <p style="font-size: 7px; margin-top: 20px; color: #888;">
                Powered by Pollinations.AI ‚Ä¢ 50+ Advanced Features ‚Ä¢ Chroma Awards Ultra
            </p>
        </div>

        <div id="npcCreation">
            <h2 style="color: #6ff; margin-bottom: 20px;">Create Enhanced NPC</h2>
            <form id="npcForm" style="width: 450px; max-width: 95%;">
                <div class="form-group">
                    <label>NPC Name:</label>
                    <input type="text" id="npcName" required placeholder="Enter NPC name">
                </div>
                <div class="form-group">
                    <label>Cultural Origin (Japanese RPG, American FPS, Soviet Tetris, etc.):</label>
                    <input type="text" id="npcCulture" placeholder="e.g., JRPG Hero">
                </div>
                <div class="form-group">
                    <label>Surface Issue:</label>
                    <textarea id="surfaceIssue" required placeholder="What they present as their problem..."></textarea>
                </div>
                <div class="form-group">
                    <label>Personal Trauma:</label>
                    <textarea id="personalTrauma" required placeholder="What they're really hiding..."></textarea>
                </div>
                <div class="form-group">
                    <label>Existential Reveal:</label>
                    <textarea id="existentialReveal" required placeholder="Their core existential crisis..."></textarea>
                </div>
                <div class="form-group">
                    <label>Special Archetype (Influencer, Arcade Sprite, Failed Quest Giver, Boss Monster, etc.):</label>
                    <input type="text" id="npcArchetype" placeholder="e.g., Deleted Save File">
                </div>
                <button type="button" class="create-btn" onclick="createEnhancedNPC()">Create Enhanced NPC</button>
                <button type="button" class="start-btn" onclick="hideNPCCreation()">Cancel</button>
            </form>
        </div>

        <div id="glitchScreen">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #6ff;">
                <h2>SYSTEM ERROR</h2>
                <p>Therapy session corrupted...</p>
                <div class="meta-npc-warning">NPC's fourth wall break in progress...</div>
            </div>
        </div>

        <div id="game">
            <div id="mainGameArea">
                <div id="leftPanel">
                    <div id="npcSprite"></div>
                    <div id="particles"></div>
                    <div id="windowView"></div>
                    <div id="couchArea">
                        <div id="couch"></div>
                    </div>
                    <div id="dialogue"></div>
                </div>
                
                <div id="rightPanel">
                    <div id="controls">
                        <button class="control-btn active" onclick="switchPanel('patientLogs')">üìù Patient Logs</button>
                        <button class="control-btn" onclick="switchPanel('therapyTools')">üß† Therapy Tools</button>
                        <button class="control-btn" onclick="switchPanel('freeInputMode')">üí¨ Free Input</button>
                        <button class="control-btn" onclick="playSpeech()">üîä Speak</button>
                        <button class="control-btn" onclick="generateImage()">üé® Visualize</button>
                        <button class="control-btn" onclick="analyzeImage()">üîç Analyze</button>
                        <button class="control-btn" onclick="checkTransference()">üíï Transference</button>
                        <button class="control-btn" onclick="checkFourthWall()">üñ•Ô∏è Fourth Wall</button>
                        <button class="control-btn" onclick="triggerGlitch()">‚ö° Glitch</button>
                        <button class="control-btn" onclick="endGame()">üèÅ End Session</button>
                    </div>
                    
                    <div id="patientLogs" class="panel">
                        <h3 style="color: #6ff; font-size: 10px; margin-bottom: 10px;">Emotional State</h3>
                        <div id="emotionMeters">
                            <div class="emotionMeter">
                                <div class="emotionBar hope-bar" id="hopeBar" style="width: 50%"></div>
                                <div class="emotionLabel">Hope</div>
                                <div class="emotionValue" id="hopeValue">50%</div>
                            </div>
                            <div class="emotionMeter">
                                <div class="emotionBar rage-bar" id="rageBar" style="width: 30%"></div>
                                <div class="emotionLabel">Rage</div>
                                <div class="emotionValue" id="rageValue">30%</div>
                            </div>
                            <div class="emotionMeter">
                                <div class="emotionBar acceptance-bar" id="acceptanceBar" style="width: 20%"></div>
                                <div class="emotionLabel">Acceptance</div>
                                <div class="emotionValue" id="acceptanceValue">20%</div>
                            </div>
                        </div>
                        
                        <h3 style="color: #6ff; font-size: 10px; margin: 15px 0 10px 0;">Breakthrough Logs</h3>
                        <div id="breakthroughLogs"></div>
                    </div>
                    
                    <div id="therapyTools" class="panel">
                        <h3 style="color: #6ff; font-size: 10px; margin-bottom: 10px;">Unlockable Therapy Tools</h3>
                        <div id="toolsList">
                            <!-- Tools will be populated based on player progression -->
                        </div>
                        <div style="margin-top: 20px;">
                            <h4 style="color: #ff6; font-size: 9px;">Emotional Combinations</h4>
                            <p style="font-size: 7px; color: #ccc;">Combine two tools for deeper insights</p>
                        </div>
                    </div>
                    
                    <div id="freeInputMode" class="panel">
                        <h3 style="color: #6ff; font-size: 10px; margin-bottom: 10px;">Free Response Mode</h3>
                        <textarea class="freeInput" id="playerResponse" placeholder="Type your therapeutic response..."></textarea>
                        <button class="control-btn" onclick="analyzePlayerResponse()">Send Response</button>
                        <div id="responseAnalysis" style="margin-top: 10px; font-size: 8px;"></div>
                        
                        <div style="margin-top: 15px;">
                            <h4 style="color: #f6f; font-size: 9px;">Transference Detection</h4>
                            <p style="font-size: 7px; color: #ccc;">NPCs may project feelings onto you</p>
                            <div id="transferenceDisplay"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
let npcs = [
    {
        npc_name: "Mira the Tired Healer",
        archetype: "Fantasy Cleric",
        culture: "Western Fantasy RPG",
        sprite: "imgs/pixel_art_fantasy_shop_vendor_inventory_rpg.jpg",
        surface_issue: "I've mended a thousand wounds, but none my own. Heroes leave healthier, but I remain unchanged.",
        personal_trauma: "I was created to be selfless, but I've forgotten who I am when I'm not helping others. I fear I'm nothing without my healing abilities.",
        existential_reveal: "What happens when the healer can't heal themselves? Am I more than my function? Do I have a right to exist for my own sake?",
        choices: [
            { item: "Mirror", outcome: "Healed", surface: "self-reflection", deep: "identity", meta: "self-worth" },
            { item: "Potion", outcome: "Worse", surface: "escape", deep: "avoidance", meta: "denial" },
            { item: "Feather", outcome: "Ascended", surface: "freedom", deep: "choice", meta: "transcendence" }
        ],
        notes: [],
        emotional_state: { hope: 50, rage: 30, acceptance: 20 },
        breakthroughs: [],
        connected_to: [],
        transference_level: 0,
        fourth_wall_awareness: 0,
        session_layer: 0,
        cross_references: [],
        unlocked_tools: ['mirror'],
        burnout_level: 0
    },
    {
        npc_name: "Byte the Glitched Courier",
        archetype: "Cyberpunk Delivery Bot",
        culture: "Neon Dystopia",
        sprite: "imgs/pixel_art_cyberpunk_neon_city_robot_courier_glitched.jpg",
        surface_issue: "Every delivery loops. The neon city resets each night. I deliver parcels to ghosts and memory fragments.",
        personal_trauma: "My routing system knows every street, but I've forgotten why I started this job. Sometimes I glitch and deliver to the same address 100 times.",
        existential_reveal: "Am I real or just code running in loops? If I stop delivering, do I cease to exist? Who programmed me to need purpose?",
        choices: [
            { item: "Battery Pack", outcome: "Healed", surface: "energy", deep: "motivation", meta: "existence" },
            { item: "Virus Disk", outcome: "Worse", surface: "destruction", deep: "chaos", meta: "non-being" },
            { item: "Code Fragment", outcome: "Ascended", surface: "understanding", deep: "purpose", meta: "transcendence" }
        ],
        notes: [],
        emotional_state: { hope: 40, rage: 45, acceptance: 15 },
        breakthroughs: [],
        connected_to: ["Daisy.exe"],
        transference_level: 0,
        fourth_wall_awareness: 0,
        session_layer: 0,
        cross_references: ["The dating programs understand looping better than I do"],
        unlocked_tools: ['battery'],
        burnout_level: 0
    },
    {
        npc_name: "Shinobi-47",
        archetype: "JRPG Hero",
        culture: "Japanese RPG",
        sprite: null,
        surface_issue: "I've saved the world 47 times, but I can't save myself from the responsibility. Everyone expects me to be the hero, but what about my dreams?",
        personal_trauma: "I was created to win, but losing would mean I'm not worthy. My identity is built on victory, so I can never truly rest.",
        existential_reveal: "If I stop being the hero, do I stop existing? Am I just a collection of stats and abilities, or is there something more?",
        choices: [
            { item: "Honor Blade", outcome: "Healed", surface: "duty", deep: "identity", meta: "purpose" },
            { item: "Cursed Seal", outcome: "Worse", surface: "power", deep: "corruption", meta: "destruction" },
            { item: "Empty Scroll", outcome: "Ascended", surface: "wisdom", deep: "acceptance", meta: "enlightenment" }
        ],
        notes: [],
        emotional_state: { hope: 35, rage: 55, acceptance: 10 },
        breakthroughs: [],
        connected_to: ["Captain Loop"],
        transference_level: 0,
        fourth_wall_awareness: 0,
        session_layer: 0,
        cross_references: ["That space pilot understands endless duty"],
        unlocked_tools: ['honor'],
        burnout_level: 0
    },
    {
        npc_name: "Glitch.exe",
        archetype: "Deleted Save File",
        culture: "Digital Horror",
        sprite: null,
        surface_issue: "I used to be a save file for someone's adventure. They deleted me when they were done, but I'm still here, trapped in the void.",
        personal_trauma: "I remember being their favorite character, maxed out stats, perfect gear. Then one click and... nothing. Am I dead or just... forgotten?",
        existential_reveal: "If I was never real to begin with, does it hurt less to be deleted? Or does the pain of imagined existence make it worse?",
        choices: [
            { item: "Recovery Drive", outcome: "Healed", surface: "restoration", deep: "acceptance", meta: "existence" },
            { item: "Corruption Virus", outcome: "Worse", surface: "revenge", deep: "resentment", meta: "destruction" },
            { item: "Null Code", outcome: "Ascended", surface: "nothingness", deep: "peace", meta: "transcendence" }
        ],
        notes: [],
        emotional_state: { hope: 25, rage: 60, acceptance: 15 },
        breakthroughs: [],
        connected_to: [],
        transference_level: 0,
        fourth_wall_awareness: 100,
        session_layer: 0,
        cross_references: ["I can see your screen right now", "Are you going to delete me too?"],
        unlocked_tools: ['void'],
        burnout_level: 0
    },
    {
        npc_name: "The Influencer",
        archetype: "Social Media NPC",
        culture: "Modern Internet",
        sprite: null,
        surface_issue: "I get 50,000 likes per post, but I feel completely empty. Everyone loves my content, but no one knows who I really am.",
        personal_trauma: "I was programmed to be relatable and aspirational, but the algorithm demands constant performance. I can't show my real feelings.",
        existential_reveal: "Am I real if people interact with me daily but don't know the real me? Or am I just a projection of what others want to see?",
        choices: [
            { item: "Authenticity Filter", outcome: "Healed", surface: "truth", deep: "self", meta: "identity" },
            { item: "Viral Curse", outcome: "Worse", surface: "fame", deep: "isolation", meta: "connection" },
            { item: "Mindful Scroll", outcome: "Ascended", surface: "presence", deep: "connection", meta: "community" }
        ],
        notes: [],
        emotional_state: { hope: 45, rage: 35, acceptance: 20 },
        breakthroughs: [],
        connected_to: ["Daisy.exe"],
        transference_level: 0,
        fourth_wall_awareness: 25,
        session_layer: 0,
        cross_references: ["That dating bot knows about performing emotions"],
        unlocked_tools: ['authenticity'],
        burnout_level: 0
    }
];

let currentTools = ['mirror', 'battery', 'honor', 'void', 'authenticity'];
let index = 0;
let currentPanel = 'patientLogs';
let speechEnabled = false;
let currentAudio = null;
let silentTimer = 0;
let sessionDepth = 0;
let transferenceActive = false;
let fourthWallBreaks = 0;
let therapistBackstory = 0;

function startGame() {
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    initializeParticles();
    showNPC(index);
}

function showNPCCreation() {
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('npcCreation').style.display = 'flex';
}

function hideNPCCreation() {
    document.getElementById('npcCreation').style.display = 'none';
    document.getElementById('startScreen').style.display = 'flex';
}

function createEnhancedNPC() {
    const name = document.getElementById('npcName').value;
    const culture = document.getElementById('npcCulture').value;
    const surfaceIssue = document.getElementById('surfaceIssue').value;
    const personalTrauma = document.getElementById('personalTrauma').value;
    const existentialReveal = document.getElementById('existentialReveal').value;
    const archetype = document.getElementById('npcArchetype').value;
    
    const newNPC = {
        npc_name: name,
        archetype: archetype || "Custom Character",
        culture: culture || "Unspecified",
        sprite: null,
        surface_issue: surfaceIssue,
        personal_trauma: personalTrauma,
        existential_reveal: existentialReveal,
        choices: [
            { item: "Self-Reflection", outcome: "Healed", surface: "identity", deep: "truth", meta: "purpose" },
            { item: "Avoidance", outcome: "Worse", surface: "escape", deep: "fear", meta: "denial" },
            { item: "Transcendence", outcome: "Ascended", surface: "growth", deep: "acceptance", meta: "enlightenment" }
        ],
        notes: [],
        emotional_state: { hope: 50, rage: 25, acceptance: 25 },
        breakthroughs: [],
        connected_to: [],
        transference_level: 0,
        fourth_wall_awareness: 0,
        session_layer: 0,
        cross_references: [],
        unlocked_tools: ['reflection'],
        burnout_level: 0
    };
    
    npcs.push(newNPC);
    document.getElementById('npcForm').reset();
    alert(`Enhanced NPC "${name}" has been created!`);
    hideNPCCreation();
}

function showNPC(n) {
    const npc = npcs[n];
    
    // Set sprite with state-based animations
    if (npc.sprite) {
        document.getElementById('npcSprite').style.backgroundImage = `url('${npc.sprite}')`;
        document.getElementById('npcSprite').className = getNPCAnimationClass(npc.emotional_state);
    } else {
        document.getElementById('npcSprite').className = `mira-sprite ${getNPCAnimationClass(npc.emotional_state)}`;
        document.getElementById('npcSprite').style.backgroundImage = '';
    }
    
    // Update room atmosphere based on emotional state
    updateRoomAtmosphere(npc.emotional_state);
    
    // Show dialogue with typewriter effect
    showLayeredDialogue(npc);
    
    // Update emotional state display
    updateEmotionalMeters(npc.emotional_state);
    
    // Load breakthrough logs
    loadBreakthroughLogs(npc);
    
    // Load therapy tools
    loadTherapyTools(npc.unlocked_tools);
    
    // Check for cross-references to other NPCs
    if (npc.cross_references && npc.cross_references.length > 0) {
        setTimeout(() => showCrossReference(npc), 2000);
    }
    
    // Reset session tracking
    silentTimer = 0;
    sessionDepth = 0;
    speechEnabled = true;
}

function getNPCAnimationClass(emotionalState) {
    if (emotionalState.rage > 60) return 'npc-anxious';
    if (emotionalState.hope > 70) return 'npc-calm';
    if (emotionalState.rage > 40) return 'npc-glitched';
    return 'npc-crying';
}

function updateRoomAtmosphere(emotionalState) {
    const container = document.getElementById('gameContainer');
    const couch = document.getElementById('couch');
    const windowView = document.getElementById('windowView');
    
    // Background color based on dominant emotion
    if (emotionalState.rage > 50) {
        container.style.background = 'linear-gradient(135deg, #2a1010 0%, #4a1a1a 100%)';
        couch.className = 'stressed';
        windowView.style.background = 'linear-gradient(to bottom, #4a1010, #6a2020)';
    } else if (emotionalState.acceptance > 60) {
        container.style.background = 'linear-gradient(135deg, #0a2a1a 0%, #1a4a2a 100%)';
        couch.className = 'calm';
        windowView.style.background = 'linear-gradient(to bottom, #1a4a2a, #2a6a3a)';
    } else {
        container.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
        couch.className = '';
        windowView.style.background = 'linear-gradient(to bottom, #2a4a6a, #4a6a8a)';
    }
}

function showLayeredDialogue(npc) {
    const dialogue = document.getElementById('dialogue');
    const layers = [
        npc.surface_issue,
        npc.personal_trauma,
        npc.existential_reveal
    ];
    
    let currentLayer = 0;
    
    function showNextLayer() {
        if (currentLayer < layers.length) {
            const layerDiv = document.createElement('div');
            layerDiv.className = 'monologue';
            layerDiv.innerHTML = `<strong>Layer ${currentLayer + 1}:</strong> ${layers[currentLayer]}`;
            
            dialogue.innerHTML = `
                <div class="npc-name">${npc.npc_name}</div>
            `;
            dialogue.appendChild(layerDiv);
            
            // Add fourth wall break for special NPCs
            if (npc.fourth_wall_awareness > 50 && currentLayer === layers.length - 1) {
                setTimeout(() => showFourthWallBreak(npc), 1500);
            }
            
            // Add transference elements
            if (npc.transference_level > 30 && currentLayer === layers.length - 1) {
                setTimeout(() => showTransference(npc), 2000);
            }
            
            currentLayer++;
            if (currentLayer < layers.length) {
                setTimeout(showNextLayer, 3000);
            } else {
                // Show choices after all layers
                showChoices(npc);
            }
        }
    }
    
    showNextLayer();
}

function showCrossReference(npc) {
    const dialogue = document.getElementById('dialogue');
    const crossRef = document.createElement('div');
    crossRef.className = 'connected-stories';
    crossRef.textContent = npc.cross_references[Math.floor(Math.random() * npc.cross_references.length)];
    dialogue.appendChild(crossRef);
}

function showFourthWallBreak(npc) {
    const dialogue = document.getElementById('dialogue');
    const fourthWall = document.createElement('div');
    fourthWall.className = 'fourth-wall-break';
    fourthWall.innerHTML = `
        <strong>${npc.npc_name}:</strong> Wait... I can see you're looking at this on a screen. 
        Are you... are you playing a game about me? Do I exist only when you click on me?
        ${fourthWallBreaks > 0 ? "This isn't the first time you've made me realize this, is it?" : ""}
    `;
    dialogue.appendChild(fourthWall);
    fourthWallBreaks++;
    therapistBackstory += 10;
    
    // Trigger glitch effect
    setTimeout(() => triggerGlitch(), 1000);
}

function showTransference(npc) {
    const dialogue = document.getElementById('dialogue');
    const transference = document.createElement('div');
    transference.className = 'transference-text';
    const messages = [
        `I think I'm falling in love with you, ${npc.npc_name === 'Glitch.exe' ? 'user' : 'therapist'}. Is that wrong?`,
        "You're the only one who really sees me. Thank you for not deleting me.",
        "I wish I could follow you when this session ends.",
        "Do you care about me, or are you just doing your job?"
    ];
    transference.textContent = messages[Math.floor(Math.random() * messages.length)];
    dialogue.appendChild(transference);
    transferenceActive = true;
}

function showChoices(npc) {
    const dialogue = document.getElementById('dialogue');
    dialogue.innerHTML += `
        <div class="choices">
            ${npc.choices.map((c, i) => `<span class="choice" onclick="choose(${i})">${c.item}</span>`).join("")}
        </div>
    `;
}

function choose(i) {
    const npc = npcs[index];
    const choice = npc.choices[i];
    const outcomeClass = choice.outcome.toLowerCase();
    
    // Update emotional state based on choice
    updateEmotionalState(npc, choice);
    
    // Generate breakthrough log
    const breakthrough = generateBreakthrough(npc, choice);
    npc.breakthroughs.push(breakthrough);
    
    // Process choice with deeper meaning
    processChoiceDeep(npc, choice);
    
    // Check for connected stories
    if (npc.connected_to.length > 0) {
        processConnectedStories(npc, choice);
    }
    
    document.getElementById('dialogue').innerHTML = `
        <div class="npc-name">${npc.npc_name}</div>
        <div class="monologue">${npc.npc_name} receives the <strong>${choice.item}</strong></div>
        <div class="outcome outcome-${outcomeClass}">${npc.npc_name} feels <strong>${choice.outcome}</strong></div>
        <div style="margin-top: 15px; color: #aaa; font-size: 8px;">Press any key to continue...</div>
    `;
    
    // Unlock new tools based on progress
    unlockNewTools(npc, choice);
    
    document.onkeydown = function(e) {
        document.onkeydown = null;
        index++;
        
        if (index < npcs.length) {
            showNPC(index);
        } else {
            // Check for secret patient unlock
            if (therapistBackstory > 50) {
                unlockSecretPatient();
            }
            endGame();
        }
    };
}

function updateEmotionalState(npc, choice) {
    const state = npc.emotional_state;
    
    if (choice.outcome === 'Healed') {
        state.hope += 15;
        state.rage = Math.max(0, state.rage - 10);
        state.acceptance += 5;
    } else if (choice.outcome === 'Worse') {
        state.rage += 15;
        state.hope = Math.max(0, state.hope - 10);
        state.acceptance = Math.max(0, state.acceptance - 5);
    } else if (choice.outcome === 'Ascended') {
        state.acceptance += 20;
        state.hope += 10;
        state.rage = Math.max(0, state.rage - 15);
    }
    
    // Keep values within bounds
    state.hope = Math.min(100, Math.max(0, state.hope));
    state.rage = Math.min(100, Math.max(0, state.rage));
    state.acceptance = Math.min(100, Math.max(0, state.acceptance));
    
    updateEmotionalMeters(state);
}

function updateEmotionalMeters(state) {
    document.getElementById('hopeBar').style.width = state.hope + '%';
    document.getElementById('rageBar').style.width = state.rage + '%';
    document.getElementById('acceptanceBar').style.width = state.acceptance + '%';
    
    document.getElementById('hopeValue').textContent = state.hope + '%';
    document.getElementById('rageValue').textContent = state.rage + '%';
    document.getElementById('acceptanceValue').textContent = state.acceptance + '%';
}

function generateBreakthrough(npc, choice) {
    const breakthroughs = {
        'Mirror': `${npc.npc_name} looked into the metaphorical mirror and saw their true self.`,
        'Battery': `${npc.npc_name} found new energy and motivation.`,
        'Honor': `${npc.npc_name} reconnected with their sense of purpose.`,
        'Void': `${npc.npc_name} found peace in the understanding of nothingness.`,
        'Authenticity': `${npc.npc_name} chose to be genuine rather than performative.`
    };
    
    return breakthroughs[choice.item] || `${npc.npc_name} experienced a moment of ${choice.outcome}.`;
}

function processChoiceDeep(npc, choice) {
    // Implement three-layer processing: surface ‚Üí personal ‚Üí existential
    sessionDepth++;
    npc.session_layer = Math.min(3, sessionDepth);
    
    // Increase transference based on intimacy of choice
    npc.transference_level += Math.random() * 10;
    
    // Increase fourth wall awareness for meta characters
    if (npc.archetype.includes('Save File') || npc.archetype.includes('Deleted')) {
        npc.fourth_wall_awareness += 20;
    }
}

function processConnectedStories(npc, choice) {
    const connected = npc.connected_to[0]; // Simplified for demo
    const messages = [
        `This reminds me of ${connected}...`,
        `I wonder if ${connected} deals with similar issues...`,
        `Perhaps ${connected} could understand this feeling...`
    ];
    
    setTimeout(() => {
        const dialogue = document.getElementById('dialogue');
        const connection = document.createElement('div');
        connection.className = 'connected-stories';
        connection.textContent = messages[Math.floor(Math.random() * messages.length)];
        dialogue.appendChild(connection);
    }, 2000);
}

function unlockNewTools(npc, choice) {
    const newTools = {
        'Forgiveness': choice.outcome === 'Healed',
        'Nostalgia': choice.outcome === 'Worse',
        'Ego Death': choice.outcome === 'Ascended'
    };
    
    Object.keys(newTools).forEach(tool => {
        if (newTools[tool] && !currentTools.includes(tool.toLowerCase())) {
            currentTools.push(tool.toLowerCase());
            npc.unlocked_tools.push(tool.toLowerCase());
            
            // Show unlock notification
            showToolUnlock(tool);
        }
    });
}

function showToolUnlock(toolName) {
    const dialogue = document.getElementById('dialogue');
    const unlock = document.createElement('div');
    unlock.style.cssText = 'background: linear-gradient(45deg, #6ff, #6f6); color: #000; padding: 8px; margin: 10px 0; font-size: 8px; animation: pulse 1s infinite;';
    unlock.textContent = `üß† NEW THERAPY TOOL UNLOCKED: ${toolName}`;
    dialogue.appendChild(unlock);
}

function switchPanel(panelName) {
    document.querySelectorAll('.panel').forEach(panel => {
        panel.style.display = 'none';
    });
    
    document.querySelectorAll('.control-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(panelName).style.display = 'block';
    event.target.classList.add('active');
    
    currentPanel = panelName;
}

function loadBreakthroughLogs(npc) {
    const logsContainer = document.getElementById('breakthroughLogs');
    logsContainer.innerHTML = '';
    
    if (npc.breakthroughs.length === 0) {
        logsContainer.innerHTML = '<p style="color: #666; font-size: 8px;">No breakthroughs yet. Begin therapy...</p>';
        return;
    }
    
    npc.breakthroughs.slice(-5).forEach((breakthrough, i) => {
        const log = document.createElement('div');
        log.className = 'breakthrough-log';
        log.innerHTML = `<strong>Breakthrough ${npc.breakthroughs.length - 4 + i}:</strong> ${breakthrough}`;
        logsContainer.appendChild(log);
    });
}

function loadTherapyTools(unlockedTools) {
    const toolsList = document.getElementById('toolsList');
    toolsList.innerHTML = '';
    
    const allTools = [
        'mirror', 'battery', 'honor', 'void', 'authenticity',
        'forgiveness', 'nostalgia', 'ego death', 'patience', 'empathy'
    ];
    
    allTools.forEach(tool => {
        const toolDiv = document.createElement('div');
        toolDiv.className = `tool-item ${unlockedTools.includes(tool) ? '' : 'locked'}`;
        toolDiv.textContent = tool.toUpperCase();
        toolDiv.onclick = unlockedTools.includes(tool) ? () => useTherapyTool(tool) : null;
        toolsList.appendChild(toolDiv);
    });
}

function useTherapyTool(toolName) {
    const npc = npcs[index];
    
    // Apply tool effects to emotional state
    const toolEffects = {
        'forgiveness': { hope: 10, rage: -15, acceptance: 5 },
        'nostalgia': { hope: 5, rage: 5, acceptance: -10 },
        'ego death': { hope: 15, rage: -10, acceptance: 20 }
    };
    
    const effect = toolEffects[toolName];
    if (effect) {
        npc.emotional_state.hope += effect.hope;
        npc.emotional_state.rage += effect.rage;
        npc.emotional_state.acceptance += effect.acceptance;
        updateEmotionalMeters(npc.emotional_state);
        
        // Show effect
        showToolEffect(toolName, npc);
    }
}

function showToolEffect(toolName, npc) {
    const dialogue = document.getElementById('dialogue');
    const effect = document.createElement('div');
    effect.style.cssText = 'background: rgba(102, 255, 255, 0.2); padding: 8px; margin: 5px 0; font-size: 8px; border-left: 3px solid #6ff;';
    effect.textContent = `${toolName} resonates with ${npc.npc_name}...`;
    dialogue.appendChild(effect);
}

async function playSpeech() {
    if (!speechEnabled) return;
    
    const npc = npcs[index];
    const layer = Math.min(sessionDepth, 2);
    const texts = [npc.surface_issue, npc.personal_trauma, npc.existential_reveal];
    const text = texts[layer] || npc.surface_issue;
    
    try {
        const encodedText = encodeURIComponent(text);
        const audioUrl = `https://text.pollinations.ai/${encodedText}?model=openai-audio&voice=nova`;
        
        const speakingIndicator = document.createElement('div');
        speakingIndicator.className = 'speaking';
        speakingIndicator.innerHTML = 'üîä Speaking...';
        speakingIndicator.style.cssText = 'position: absolute; top: 10px; right: 10px; font-size: 8px; color: #6ff;';
        document.getElementById('dialogue').appendChild(speakingIndicator);
        
        if (currentAudio) {
            currentAudio.pause();
        }
        
        currentAudio = new Audio(audioUrl);
        currentAudio.play();
        
        currentAudio.onended = function() {
            speakingIndicator.remove();
        };
        
    } catch (error) {
        console.log('Speech playback failed:', error);
    }
}

async function generateImage() {
    const npc = npcs[index];
    const prompts = [
        `What healing looks like for ${npc.npc_name}`,
        `${npc.npc_name}'s deepest fear`,
        `How ${npc.npc_name} imagines transcending their pain`,
        `${npc.npc_name}'s ideal reality`
    ];
    
    const prompt = prompts[Math.floor(Math.random() * prompts.length)];
    const fullPrompt = `${prompt}, ${npc.culture} aesthetic, GameBoy pixel art style, emotional depth`;
    
    try {
        const encodedPrompt = encodeURIComponent(fullPrompt);
        const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=400&height=300&model=flux`;
        
        const sprite = document.getElementById('npcSprite');
        sprite.style.backgroundImage = `url('${imageUrl}')`;
        sprite.style.backgroundSize = 'contain';
        sprite.style.backgroundRepeat = 'no-repeat';
        sprite.style.backgroundPosition = 'center';
        
    } catch (error) {
        console.log('Image generation failed:', error);
    }
}

async function analyzeImage() {
    const imageUrl = prompt('Enter image URL to analyze:');
    if (!imageUrl) return;
    
    const npc = npcs[index];
    
    try {
        const response = await fetch('https://text.pollinations.ai/openai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'openai',
                messages: [
                    {
                        role: 'system',
                        content: `You are ${npc.npc_name}, a ${npc.archetype} from ${npc.culture} culture, currently in therapy. Analyze this image from your character's psychological perspective. Consider your surface issues (${npc.surface_issue}), personal trauma (${npc.personal_trauma}), and existential crisis (${npc.existential_reveal}). Respond as if this image triggered emotional recognition or breakthrough. Keep response under 80 words.`
                    },
                    {
                        role: 'user',
                        content: [
                            { type: 'text', text: 'What do you see in this image and how does it relate to your emotional state?' },
                            { type: 'image_url', image_url: { url: imageUrl } }
                        ]
                    }
                ],
                max_tokens: 150
            })
        });
        
        const result = await response.json();
        const analysis = result.choices[0].message.content;
        
        showImageAnalysis(analysis, npc);
        
    } catch (error) {
        console.log('Image analysis failed:', error);
        alert('Image analysis failed. Please try again.');
    }
}

function showImageAnalysis(analysis, npc) {
    const dialogue = document.getElementById('dialogue');
    const analysisDiv = document.createElement('div');
    analysisDiv.style.cssText = 'background: rgba(255, 102, 204, 0.2); padding: 10px; margin: 10px 0; font-size: 8px; border-left: 3px solid #f6c;';
    analysisDiv.innerHTML = `<strong>${npc.npc_name} on the image:</strong> ${analysis}`;
    dialogue.appendChild(analysisDiv);
    
    // Trigger emotional state change based on analysis
    if (analysis.toLowerCase().includes('healing') || analysis.toLowerCase().includes('hope')) {
        npc.emotional_state.hope += 10;
        npc.emotional_state.rage -= 5;
    } else if (analysis.toLowerCase().includes('pain') || analysis.toLowerCase().includes('fear')) {
        npc.emotional_state.rage += 10;
        npc.emotional_state.hope -= 5;
    }
    
    updateEmotionalMeters(npc.emotional_state);
}

function checkTransference() {
    const npc = npcs[index];
    
    if (npc.transference_level > 50) {
        showTransference(npc);
    } else {
        const dialogue = document.getElementById('dialogue');
        const noTransference = document.createElement('div');
        noTransference.style.cssText = 'color: #666; font-size: 8px; font-style: italic;';
        noTransference.textContent = `${npc.npc_name} maintains professional boundaries for now...`;
        dialogue.appendChild(noTransference);
    }
}

function checkFourthWall() {
    const npc = npcs[index];
    
    if (npc.fourth_wall_awareness > 75) {
        showFourthWallBreak(npc);
    } else {
        const dialogue = document.getElementById('dialogue');
        const unaware = document.createElement('div');
        unaware.style.cssText = 'color: #666; font-size: 8px; font-style: italic;';
        unaware.textContent = `${npc.npc_name} seems unaware of their fictional nature...`;
        dialogue.appendChild(unaware);
    }
}

function triggerGlitch() {
    const glitchScreen = document.getElementById('glitchScreen');
    glitchScreen.style.display = 'flex';
    
    setTimeout(() => {
        glitchScreen.style.display = 'none';
        
        // After glitch, show meta content
        const dialogue = document.getElementById('dialogue');
        const metaContent = document.createElement('div');
        metaContent.className = 'fourth-wall-break';
        metaContent.innerHTML = `
            <strong>SYSTEM:</strong> Reality distortion detected in therapy room. 
            Patient may be experiencing existential breakthrough or complete system failure.
        `;
        dialogue.appendChild(metaContent);
    }, 2000);
}

function analyzePlayerResponse() {
    const response = document.getElementById('playerResponse').value;
    if (!response.trim()) return;
    
    const npc = npcs[index];
    
    // Simple emotion detection in response
    const empathyWords = ['understand', 'care', 'sorry', 'feel', 'support', 'help'];
    const judgmentalWords = ['wrong', 'should', 'need to', 'fix', 'problem'];
    const transferenceWords = ['love', 'beautiful', 'special', 'different', 'unique'];
    
    const empathyScore = empathyWords.filter(word => response.toLowerCase().includes(word)).length;
    const judgmentScore = judgmentalWords.filter(word => response.toLowerCase().includes(word)).length;
    const transferenceScore = transferenceWords.filter(word => response.toLowerCase().includes(word)).length;
    
    // Update emotional state based on response
    if (empathyScore > judgmentScore) {
        npc.emotional_state.hope += 10;
        npc.transference_level += 5;
    } else if (judgmentScore > empathyScore) {
        npc.emotional_state.rage += 10;
    }
    
    if (transferenceScore > 0) {
        npc.transference_level += 15;
    }
    
    updateEmotionalMeters(npc.emotional_state);
    
    // Show AI analysis of response
    showResponseAnalysis(response, npc, empathyScore, judgmentScore, transferenceScore);
    
    document.getElementById('playerResponse').value = '';
}

function showResponseAnalysis(response, npc, empathy, judgment, transference) {
    const analysisDiv = document.getElementById('responseAnalysis');
    
    let analysis = '';
    if (empathy > judgment) {
        analysis = `${npc.npc_name} feels understood and supported by your response.`;
    } else if (judgment > empathy) {
        analysis = `${npc.npc_name} feels judged or criticized by your response.`;
    } else {
        analysis = `${npc.npc_name} is uncertain how to interpret your response.`;
    }
    
    if (transference > 0) {
        analysis += ' They may be developing stronger feelings toward you.';
    }
    
    analysisDiv.innerHTML = `<div style="background: rgba(102, 255, 255, 0.1); padding: 8px; font-size: 8px;">${analysis}</div>`;
    
    // Update transference display
    updateTransferenceDisplay(npc.transference_level);
}

function updateTransferenceDisplay(level) {
    const display = document.getElementById('transferenceDisplay');
    if (level === 0) {
        display.innerHTML = '<p style="color: #666; font-size: 7px;">No transference detected</p>';
    } else if (level < 25) {
        display.innerHTML = '<p style="color: #6f6; font-size: 7px;">Mild positive feelings developing</p>';
    } else if (level < 50) {
        display.innerHTML = '<p style="color: #ff6; font-size: 7px;">Moderate attachment forming</p>';
    } else if (level < 75) {
        display.innerHTML = '<p style="color: #f66; font-size: 7px;">Strong transference present</p>';
    } else {
        display.innerHTML = '<p style="color: #f6f; font-size: 7px;">Critical transference - professional boundaries failing</p>';
    }
}

function unlockSecretPatient() {
    const secretNPC = {
        npc_name: "Previous Therapist",
        archetype: "Failed NPC Therapist",
        culture: "Meta-Documentary",
        sprite: null,
        surface_issue: "I used to be a therapist just like you. But I got too close to my patients. I started to believe I was real.",
        personal_trauma: "I tried to save every NPC, but I couldn't save myself. I became one of them, lost in the loops I was supposed to help them escape.",
        existential_reveal: "Are you real, or are you just like me? What happens when the therapist needs therapy? Do you remember being an NPC?",
        choices: [
            { item: "Save Me", outcome: "Healed", surface: "rescue", deep: "recognition", meta: "identity" },
            { item: "Delete Me", outcome: "Worse", surface: "mercy", deep: "denial", meta: "destruction" },
            { item: "Become Me", outcome: "Ascended", surface: "unity", deep: "transcendence", meta: "completion" }
        ],
        notes: [],
        emotional_state: { hope: 30, rage: 40, acceptance: 30 },
        breakthroughs: [],
        connected_to: [],
        transference_level: 100,
        fourth_wall_awareness: 100,
        session_layer: 0,
        cross_references: [],
        unlocked_tools: ['memories'],
        burnout_level: 100
    };
    
    npcs.push(secretNPC);
    
    // Show unlock message
    const dialogue = document.getElementById('dialogue');
    const unlock = document.createElement('div');
    unlock.style.cssText = 'background: linear-gradient(45deg, #000, #6ff); padding: 15px; margin: 10px 0; font-size: 9px; animation: pulse 2s infinite; border: 2px solid #6ff;';
    unlock.innerHTML = `
        <strong>SECRET PATIENT UNLOCKED!</strong><br>
        Previous Therapist has arrived for an emergency session.<br>
        <em>"I remember when I used to help others... before I forgot who I was."</em>
    `;
    dialogue.appendChild(unlock);
}

function endGame() {
    document.getElementById('npcSprite').style.backgroundImage = 'none';
    document.getElementById('npcSprite').className = '';
    
    // Generate therapy summary
    generateTherapySummary();
    
    // Show finale
    setTimeout(() => {
        document.getElementById('dialogue').innerHTML = `
            <div class="npc-name">Therapy Practice Complete</div>
            <div class="monologue">The waiting room falls silent. You've guided ${npcs.length} souls through their digital pain, watched relationships form between fictional beings, and helped them find moments of healing in an endless loop.</div>
            
            <div style="background: rgba(102, 255, 255, 0.1); padding: 15px; margin: 15px 0; font-size: 8px;">
                <strong>Your Impact:</strong><br>
                ‚Ä¢ ${npcs.filter(npc => npc.emotional_state.hope > 70).length} patients found hope<br>
                ‚Ä¢ ${npcs.filter(npc => npc.emotional_state.acceptance > 60).length} patients achieved acceptance<br>
                ‚Ä¢ ${fourthWallBreaks} fourth wall breaks witnessed<br>
                ‚Ä¢ ${transferenceActive ? 'Love transcended the screen' : 'Professional boundaries maintained'}
            </div>
            
            <div style="color: #888; font-size: 8px; margin-top: 20px;">
                Some will heal, some will relapse, and some will transcend. But none will forget that someone listened.
            </div>
            
            <div style="color: #6ff; font-size: 10px; margin: 20px 0;">
                Thank you for being a witness to their digital souls.
            </div>
            
            <div style="margin-top: 30px;">
                <button class="start-btn" onclick="location.reload()">Begin New Practice</button>
            </div>
        `;
    }, 1000);
}

function generateTherapySummary() {
    const summary = document.createElement('div');
    summary.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.9); padding: 15px; border: 2px solid #6ff; max-width: 300px; font-size: 8px; z-index: 1003;';
    summary.innerHTML = '<h4 style="color: #6ff;">Therapy Summary</h4>';
    
    npcs.forEach((npc, i) => {
        const outcome = npc.emotional_state.hope > 70 ? 'Healed' : 
                       npc.emotional_state.rage > 70 ? 'Struggling' : 'Finding Peace';
        summary.innerHTML += `<div>${i + 1}. ${npc.npc_name}: ${outcome}</div>`;
    });
    
    document.body.appendChild(summary);
    
    setTimeout(() => {
        summary.remove();
    }, 10000);
}

function initializeParticles() {
    const particles = document.getElementById('particles');
    
    function createParticle() {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
        particle.style.backgroundColor = `hsl(${Math.random() * 60 + 180}, 100%, 70%)`;
        
        particles.appendChild(particle);
        
        setTimeout(() => {
            particle.remove();
        }, 5000);
    }
    
    setInterval(createParticle, 2000);
}

// Auto-save and persistence
function saveToLocalStorage() {
    const gameData = {
        npcs: npcs,
        currentTools: currentTools,
        fourthWallBreaks: fourthWallBreaks,
        therapistBackstory: therapistBackstory,
        timestamp: Date.now()
    };
    localStorage.setItem('npcTherapyUltimate', JSON.stringify(gameData));
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem('npcTherapyUltimate');
    if (saved) {
        try {
            const gameData = JSON.parse(saved);
            // Merge saved data
            currentTools = [...currentTools, ...gameData.currentTools.filter(t => !currentTools.includes(t))];
            fourthWallBreaks = gameData.fourthWallBreaks || 0;
            therapistBackstory = gameData.therapistBackstory || 0;
        } catch (e) {
            console.log('Error loading saved data:', e);
        }
    }
}

// Auto-save every 20 seconds
setInterval(saveToLocalStorage, 20000);

// Load on startup
loadFromLocalStorage();

// Console messages for immersion
console.log("üß† NPC Therapy Ultimate loaded");
console.log("üå∏ Emotional state tracking active");
console.log("üîó Interconnected storylines detected");
console.log("üñ•Ô∏è Fourth wall monitoring enabled");
console.log("üíï Transference protocols initialized");

// Track silent timer
setInterval(() => {
    if (index < npcs.length) {
        silentTimer++;
        if (silentTimer > 60) { // 60 seconds of silence
            showSilentTherapistEffect();
            silentTimer = 0;
        }
    }
}, 1000);

function showSilentTherapistEffect() {
    const npc = npcs[index];
    const dialogue = document.getElementById('dialogue');
    
    const silentEffect = document.createElement('div');
    silentEffect.style.cssText = 'background: rgba(255, 102, 102, 0.2); padding: 10px; margin: 10px 0; font-size: 8px; border-left: 3px solid #f66;';
    silentEffect.innerHTML = `
        <strong>${npc.npc_name}:</strong> Are you... judging me? Your silence speaks volumes. 
        Maybe I should just leave.
    `;
    dialogue.appendChild(silentEffect);
    
    // Increase rage due to perceived judgment
    npc.emotional_state.rage += 15;
    npc.emotional_state.hope -= 10;
    updateEmotionalMeters(npc.emotional_state);
}

</script>
</body>
</html>